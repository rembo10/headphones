<%inherit file="base.html"/>

<%!
    import headphones
    import string
%>

<%page args="tabs, config"/>

<%def name="headerIncludes()">
    <meta name="author" content="Koryukov Maksim">

    <div id="subhead_container">
        <div id="subhead_menu">
            <a id="menu_link_shutdown" href="shutdown"><i class="fa fa-power-off"></i> Shut Down</a>
            <a id="menu_link_shutdown" href="restart"><i class="fa fa-power-off"></i> Restart</a>
        </div>
    </div>
</%def>

<%def name="body()">
<div class="config">
    <div id="paddingheader">
        <h1 class="clearfix"><i class="fa fa-gear"></i> Settings</h1>
    </div>

    <%doc>
        TODO : THIS IS A SCRUTCH!!! Remove this jquery-tag out there!!!
    </%doc>
    <script src="js/libs/jquery-1.11.1.min.js"></script>

    <form action="configUpdate" method="post" class="form" id="configUpdate">
        <div id="tabs" class="tabs">
            <ul>
                % for tab in tabs:
                <li><a href="#${tab.id}">${tab.caption}</a></li>
                % endfor
            </ul>

            % for tab in tabs:
                ${tab.render(me=tab, parent=None)}
            % endfor
        </div>
    </form>
</div>
</%def>

<%def name="javascriptIncludes()">
    <script type="text/javascript">
        $(document).ready(function(){

            ## TODO : move this to the config-templates, because this bindings are
            ##        parts of the templates. It is not directly linked to current
            ##        template.
            ## vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
            $("body").on("click", ".hp-option-switch", function(){
                $el = $(this);
                var divselector = $el.data('embed-div');
                if (divselector){
                    var $div = $(divselector);
                    if ($el.is(":checked")){
                        $div.slideDown();
                    } else {
                        $div.slideUp();
                    }
                }
            });

            $("body").on("click", ".checkbox-with-storage", function(){
                $el = $(this);
                var hisel = $el.data('hidden-sel');
                if (hisel){
                    var $h = $(hisel);
                    if ($el.is(":checked")){
                        $h.val('1');
                    } else {
                        $h.val('0');
                    }
                }
            });

            ## ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

        });
    </script>



    <script>

        hideServerDivs = function () {
                $("#customoptions").slideUp();
                $("#hpserveroptions").slideUp();
        };

        hideEncoderDivs = function () {
                $("#lameffmpegproperties").slideUp();
                $("#xldproperties").slideUp();
        };
        hideEncodingOptionDivs = function () {
                $("#vbr_options").slideUp();
                $("#cbr_options").slideUp();
        };

        handleNewServerSelection = function () {
                hideServerDivs();

                switch ($(this).val()) {
                        case 'custom':
                            $("#customoptions").slideDown();
                        break;
                        case 'headphones':
                            $("#hpserveroptions").slideDown();
                        break;
                }
        };

        handleNewEncoderSelection = function () {
                hideEncoderDivs();

                switch ($(this).val()) {
                        case 'xld':
                            $("#xldproperties").slideDown();
                            break;
                        case 'ffmpeg':
                            $("#lameffmpegproperties").slideDown();
                            break;
                        case 'libav':
                            $("#lameffmpegproperties").slideDown();
                            break;
                        case 'lame':
                            $("#lameffmpegproperties").slideDown();
                            break;
                }
        };

        handleNewEncodingOptionSelection = function () {
                hideEncodingOptionDivs();

                switch ($(this).val()) {
                        case 'vbr':
                            $("#vbr_options").slideDown();
                            break;
                        case 'cbr':
                            $("#cbr_options").slideDown();
                            break;
                }
        };

        function openExtrasDialog() {
            $("#dialog").dialog({ close: function(){
                var elem = '<input type="button" data-success="Changes saved successfully">';
                doAjaxCall('configUpdate', elem,'tabs',true);
            }}).dialog("open");
        };

        function initThisPage()
        {

                if ($("#nzb_downloader_sabnzbd").is(":checked"))
                        {
                            $("#sabnzbd_options").show();
                            $("#nzbget_options,#blackhole_options").hide();
                        }
                if ($("#nzb_downloader_nzbget").is(":checked"))
                        {
                            $("#sabnzbd_options,#blackhole_options").hide();
                            $("#nzbget_options").show();
                        }
                if ($("#nzb_downloader_blackhole").is(":checked"))
                        {
                            $("#sabnzbd_options,#nzbget_options").hide();
                            $("#blackhole_options").show();
                        }

                if ($("#torrent_downloader_blackhole").is(":checked"))
                        {
                            $("#transmission_options,#utorrent_options").hide();
                            $("#torrent_blackhole_options").show();
                        }
                if ($("#torrent_downloader_transmission").is(":checked"))
                        {
                            $("#torrent_blackhole_options,#utorrent_options").hide();
                            $("#transmission_options").show();
                        }
                if ($("#torrent_downloader_utorrent").is(":checked"))
                        {
                            $("#torrent_blackhole_options,#transmission_options").hide();
                            $("#utorrent_options").show();
                        }

                $('input[type=radio]').change(function(){
                        if ($("#preferred_bitrate").is(":checked"))
                        {
                            $("#preferred_bitrate_options").slideDown("fast");
                            $("#lossless_only_options").slideUp("fast");
                        }
                        if ($("#preferred_quality0").is(":checked"))
                        {
                            $("#preferred_bitrate_options").slideUp("fast");
                            $("#lossless_only_options").slideUp("fast");
                        }
                        if ($("#preferred_quality1").is(":checked"))
                        {
                            $("#preferred_bitrate_options").slideUp("fast");
                            $("#lossless_only_options").slideUp("fast");
                        }
                        if ($("#lossless_only").is(":checked"))
                        {
                            $("#lossless_only_options").slideDown("fast");
                            $("#preferred_bitrate_options").slideUp("fast");
                        }
                        if ($("#nzb_downloader_sabnzbd").is(":checked"))
                        {
                            $("#nzbget_options,#blackhole_options").fadeOut("fast", function() { $("#sabnzbd_options").fadeIn() });
                        }
                        if ($("#nzb_downloader_nzbget").is(":checked"))
                        {
                            $("#sabnzbd_options,#blackhole_options").fadeOut("fast", function() { $("#nzbget_options").fadeIn() });
                        }
                        if ($("#nzb_downloader_blackhole").is(":checked"))
                        {
                            $("#sabnzbd_options,#nzbget_options").fadeOut("fast", function() { $("#blackhole_options").fadeIn() });
                        }
                        if ($("#torrent_downloader_blackhole").is(":checked"))
                        {
                            $("#transmission_options,#utorrent_options").fadeOut("fast", function() { $("#torrent_blackhole_options").fadeIn() });
                        }
                        if ($("#torrent_downloader_transmission").is(":checked"))
                        {
                            $("#torrent_blackhole_options,#utorrent_options").fadeOut("fast", function() { $("#transmission_options").fadeIn() });
                        }
                        if ($("#torrent_downloader_utorrent").is(":checked"))
                        {
                            $("#torrent_blackhole_options,#transmission_options").fadeOut("fast", function() { $("#utorrent_options").fadeIn() });
                        }
                });

                $("#mirror").change(handleNewServerSelection);
                        handleNewServerSelection.apply($("#mirror"));

                $("#encoder").change(handleNewEncoderSelection);
                        handleNewEncoderSelection.apply($("#encoder"));

                $("#encodervbrcbr").change(handleNewEncodingOptionSelection);
                        handleNewEncodingOptionSelection.apply($("#encodervbrcbr"));

                var deletedNewznabs = 0;

                $(".remove").click(function() {
                    $(this).parent().parent().remove();
                    deletedNewznabs = deletedNewznabs + 1;
                });

                var deletedTorznabs = 0;

                $(".remove_torznab").click(function() {
                    $(this).parent().parent().remove();
                    deletedTorznabs = deletedTorznabs + 1;
                });

                $("#modify_extras").click(openExtrasDialog);

                $("#include_extras").click(function(){
                    if ($("#include_extras").is(":checked")){
                        openExtrasDialog();
                    }
                });

                ## %for extra in config['extras']:
                ## $("#${extra}_temp").click(function(){
                ##     if ($(this).is(":checked")){
                ##         $("#${extra}").attr("checked", true);
                ##     }
                ##     else {
                ##         $("#${extra}").attr("checked", false);
                ##     }
                ## });
                ## %endfor

                $("#add_newznab").click(function() {
                    var intId = $("#newznab_providers > div").size() + deletedNewznabs + 1;
                    var formfields = $("<div class=\"config\" id=\"newznab" + intId + "\"><div class=\"row\"><label>Newznab Host</label><input type=\"text\" name=\"newznab_host" + intId + "\" size=\"30\"></div><div class=\"row\"><label>Newznab API</label><input type=\"text\" name=\"newznab_api" + intId + "\" size=\"36\"></div><div class=\"row checkbox\"><input type=\"checkbox\" name=\"newznab_enabled" + intId + "\" value=\"1\" checked /><label>Enabled</label></div>");
                    var removeButton = $("<div class=\"row\"><input type=\"button\" class=\"remove\" value=\"Remove\" /></div>");
                    removeButton.click(function() {
                        $(this).parent().remove();
                        deletedNewznabs = deletedNewznabs + 1;

                    });
                    formfields.append(removeButton);
                    formfields.append("</div>");
                    $("#add_newznab").before(formfields);
                });

                $("#add_torznab").click(function() {
                    var intId = $("#torznab_providers > div").size() + deletedTorznabs + 1;
                    var formfields = $("<div class=\"config\" id=\"torznab" + intId + "\"><div class=\"row\"><label>Torznab Host</label><input type=\"text\" name=\"torznab_host" + intId + "\" size=\"30\"></div><div class=\"row\"><label>Torznab API</label><input type=\"text\" name=\"torznab_api" + intId + "\" size=\"36\"></div><div class=\"row checkbox\"><input type=\"checkbox\" name=\"torznab_enabled" + intId + "\" value=\"1\" checked /><label>Enabled</label></div>");
                    var removeTorznabButton = $("<div class=\"row\"><input type=\"button\" class=\"remove_torznab\" value=\"Remove\" /></div>");
                    removeTorznabButton.click(function() {
                        $(this).parent().remove();
                        deletedTorznabs = deletedTorznabs + 1;

                    });
                    formfields.append(removeTorznabButton);
                    formfields.append("</div>");
                    $("#add_torznab").before(formfields);
                });

                $(".hpuser").keyup(function() {
                    $(".hpuser").val($(this).val());
                });

                $(".hppass").keyup(function() {
                    $(".hppass").val($(this).val());
                });

                $(function() {
                    $( ".tabs" ).tabs();
                });
                initActions();



                $('#twitterStep1').click(function () {
                    $.get("/twitterStep1", function (data) {window.open(data); })
                    .done(function () { $('#ajaxMsg').html("<div class='msg'><span class='ui-icon ui-icon-check'></span>Confirm Authorization. Check pop-up blocker if no response.</div>"); });
                    $('#ajaxMsg').addClass('success').fadeIn().delay(3000).fadeOut();
                });

                $('#twitterStep2').click(function () {
                    var twitter_key = $("#twitter_key").val();
                    $.get("/twitterStep2", {'key': twitter_key}, function (data) { $('#ajaxMsg').html("<div class='msg'><span class='ui-icon ui-icon-check'></span>"+data+"</div>"); });
                    $('#ajaxMsg').addClass('success').fadeIn().delay(3000).fadeOut();
                });

                $('#testTwitter').click(function () {
                    $.get("/testTwitter",
                        function (data) { $('#ajaxMsg').html("<div class='msg'><span class='ui-icon ui-icon-check'></span>"+data+"</div>"); });
                    $('#ajaxMsg').addClass('success').fadeIn().delay(3000).fadeOut();
                });

                $('#osxnotifyregister').click(function () {
                    var osx_notify_app = $("#osx_notify_reg").val();
                    $.get("/osxnotifyregister", {'app': osx_notify_app}, function (data) { $('#ajaxMsg').html("<div class='msg'><span class='ui-icon ui-icon-check'></span>"+data+"</div>"); });
                    $('#ajaxMsg').addClass('success').fadeIn().delay(3000).fadeOut()
                })
        }

        $(document).ready(function() {
            initThisPage();
        });

    </script>
</%def>
